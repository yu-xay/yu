###保存点
- 例如账户A向多个账户转账 向其中一个操作失败 不影响其他的
- SAVEPOINT 为事务设置名称 ROLLBCK TO 将事务回滚到指定保存点而不是终止事务
```
set session autocommit=0;
begin;
update departments set dept_name = 3 where dept_no = 'd009';
savepoint a;
update departments set dept_name = 4 where dept_no = 'd008';
rollback to a;
commit;
```

### 事务 ACID ###
如果一个数据库声称支持事务的操作，那么该数据库必须要具备以下四个特性：
- 原子性（Atomicity）  指一个事务要么全部执行,要么不执行.也就是说一个事务不可能只执行了一半就停止了
- 一致性（Consistency）指事务的运行并不改变数据库中数据的一致性.例如,完整性约束了a+b=10,一个事务改变了a,那么b也应该随之改变
- 隔离性（Isolation）  事务的独立性也有称作隔离性,是指两个以上的事务不会出现交错执行的状态.因为这样可能会导致数据不一致
- 持久性（Durability） 事务的持久性是指事务执行成功以后,该事务所对数据库所作的更改便是持久的保存在数据库之中，不会无缘无故的回滚.

###隔离级别
- [系统变量](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_transaction_isolation)
- SHOW VARIABLES LIKE "%tx_isolation%"  <8.0
- SELECT @@transaction_isolation;   >=8.0

| 隔离级别 | 脏读 | 不可重复读          |    幻读   |
| --- | --- | ---                      |    ---    |
| READ-UNCOMMITTED (读取未提交内容)     | √ | √ | √ |
| READ-COMMITTED (读取提交内容)         | × | √ | √ |
| REPEATABLE-READ (可重复读) Mysql默认  | × | × | √ |
| SERIALIZABLE (可串行化)             | × | × | × |
    
    
### 隔离性
- 脏读：一个事务读取到了其他事务还没有提交的数据；
- 不可重复读：一个事务在进行中读取到了其他事务对旧数据的修改结果；同一个事务2次读不一样
- 幻读：读取到了其他事务新增的数据，仿佛出现了幻象。(幻读与不可重复读类似，不可重复读是读到了其他事务update/delete的结果，幻读是读到了其他事务insert的结果);
- 更新丢失：当两个事务选择同一行，然后更新数据，由于每个事务都不知道其他事务的存在，就会发生丢失更新的问题；
- 序列化： 通过把选定的所有行锁起来，序列化可以提供最高级别的隔离

### 多版本并发控制(MVCC)
    - 一个事务通过第一个语句只能看到相同的数据，即使另外一个事务已提交数据。
      在同一个事务中，读取通过第一次读取建立的快照是一致的。 一个例外是，一个事务可以读取在同一个事务中更改的内容
    
    - 当事务开始并执行第一次读取数据时，将创建读取视图并保持打开状态，直到事务结束。
        为了在事务结束之前提供相同的结果集，InnoDB使用行版本控制和UNDO信息。

    - 例如事务1 选择了 几行，另一个事务删除了这些行并提交了事务。
        如果事务1处于打开状态，它应该能够看到自己在开始时选择的行，
        已被删除的行保留在UNDO日志空间已履行事务1。 一旦事务1操作完成 这些行便从UNDO日志中删除。这便是 多版本并发控制
    - 上述适用于
### 锁